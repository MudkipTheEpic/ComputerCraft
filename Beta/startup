local StartScreen = paintutils.loadImage(".OSRunner/Resources/logo")
local W, H = term.getSize()
local nfs = {}
for i,v in pairs(fs) do
	nfs[i] = v
end 

local ShouldExist = {
".OSRunner/Keep";
".OSRunner/Kernels";
}

local function CenterPrint(Text, Line)
	if not Line then local _,Line=term.getCursorPos() end
	term.setCursorPos((W-#Text)/2, Line)
	print(Text)
end 

local function CenterWrite(Text, Line)
	if not Line then local _,Line=term.getCursorPos() end
	term.setCursorPos((W-#Text)/2, Line)
	write(Text)
end 

local function EraseData()
	if nfs.exists(".OSRunner/Kernels") then
		nfs.delete(".OSRunner/Kernels")
	end 
end 

local function Setup()
	EraseData()
	nfs.makeDir(".OSRunner/Kernels")
	nfs.makeDir(".OSRunner/Keep")
	nfs.makeDir(".OSRunner/Kernels/CraftOS")
end 

local function Sand(Dir, OSName, SetupFile, SetupURL)
	os.run({},".OSRunner/APIs/osrunner")
	sandbox.load(Dir, OSName, SetupFile, SetupURL)
end 


shell.run(".OSRunner/APIs/osrunner")

term.setBackgroundColor(colors.lime)
term.clear()
paintutils.drawImage(StartScreen, 8, 4)

term.setCursorPos(1, H-1)
term.setBackgroundColor(colors.lime)
term.setTextColor(colors.gray)
local handle = fs.open("/.OSRunner/osConfig","r")
defaultOS = handle.readLine()
handle.close()
CenterPrint("Running Default OS: "..defaultOS)
CenterWrite("Press F5 for OSRunner Menu")




local function CheckFiles()

end 

local function StartLoader()
	local currentOS=1
	local ShouldSet = false
	for i,v in pairs(ShouldExist) do
		if not nfs.exists(v) then
			ShouldSet = true
		end 
	end 
	if ShouldSet == true then
		Setup()
	end 
	local OSList=nfs.list(".OSRunner/OSList/")
	local handle = fs.open("/.OSRunner/osConfig","r")
	local defaultOS = handle.readLine()
	handle.close()
	while true do
		local Main = paintutils.loadImage(".OSRunner/Resources/main")
		term.setBackgroundColor(colors.white)
		term.clear()
		paintutils.drawImage(Main, 1, 1)
		term.setBackgroundColor(colors.red)
		term.setTextColor(colors.white)
		CenterPrint("OSRunner Options", 1)
		term.setBackgroundColor(colors.lightGray)
		term.setTextColor(colors.black)
		term.setCursorPos(4, 12)
		if currentOS==1 then term.setTextColor(colors.gray) end
		write("Back")
		if currentOS==1 then term.setTextColor(colors.black) end
		term.setCursorPos(45, 12)
		if currentOS==#OSList then term.setTextColor(colors.gray) end
		write("Next")
		if currentOS==#OSList then term.setTextColor(colors.black) end
		term.setCursorPos(4, 15)
		if not fs.exists(".OSRunner/Kernels/"..OSList[currentOS]) then term.setTextColor(colors.gray) end
		write("Delete OS")
		if not fs.exists(".OSRunner/Kernels/"..OSList[currentOS]) then term.setTextColor(colors.black) end
		term.setCursorPos(2, 17)
		write("System Settings")
		term.setCursorPos(22, 16)
		write("Launch OS")
		term.setCursorPos(40,15)
		if currentOS==1 then term.setTextColor(colors.gray) end
		write("First")
		if currentOS==1 then term.setTextColor(colors.black) end
		term.setCursorPos(40,17)
		if currentOS==#OSList then term.setTextColor(colors.gray) end
		write("Last")
		if currentOS==#OSList then term.setTextColor(colors.black) end
		term.setBackgroundColor(colors.lightGray)
		term.setCursorPos(2, 3)
		term.write(string.rep(" ", W - 2))
		local v=OSList[currentOS]
		CenterPrint(v, 3)
		term.setCursorPos(2,19)
		term.setBackgroundColor(colors.gray)
		term.setTextColor(colors.white)
		CenterWrite("Default OS: "..defaultOS)
		local event,btw,x,y=os.pullEventRaw("mouse_click")
		if x >= 4 and x <= 7 and y==12 and currentOS > 1 then
			currentOS=currentOS-1
		elseif x >= 45 and x <= 48 and y==12 and currentOS < #OSList then
			currentOS=currentOS+1
		elseif x >= 4 and x <= 12 and y==15 and fs.exists(".OSRunner/Kernels/"..OSList[currentOS]) then
			fs.delete(".OSRunner/Kernels/"..OSList[currentOS])
			term.setTextColor(colors.black)
			CenterPrint("Deleted "..OSList[currentOS],5)
			sleep(1)
		elseif x >= 2 and x <= 17 and y==17 then
			while true do
				term.clear()
				local gui = paintutils.loadImage("/.OSRunner/systemSettings")
				paintutils.drawImage(gui,1,1)
				term.setBackgroundColor(colors.red)
				term.setTextColor(colors.white)
				CenterPrint("System Settings",1)
				term.setBackgroundColor(colors.lightGray)
				term.setTextColor(colors.black)
				CenterPrint(OSList[currentOS],3)
				term.setCursorPos(3,5)
				local handle = fs.open("/.OSRunner/osConfig","r")
				defaultOS = handle.readLine()
				handle.close()
				if defaultOS == OSList[currentOS] then
					term.setBackgroundColor(colors.lime)
				else
					term.setBackgroundColor(colors.red)
				end
				term.write("Default OS")
				term.setBackgroundColor(colors.lightGray)
				term.setTextColor(colors.black)
				term.setCursorPos(4, 12)
				if currentOS==1 then term.setTextColor(colors.gray) end
				write("Back")
				if currentOS==1 then term.setTextColor(colors.black) end
				term.setCursorPos(45, 12)
				if currentOS==#OSList then term.setTextColor(colors.gray) end
				write("Next")
				if currentOS==#OSList then term.setTextColor(colors.black) end
				term.setCursorPos(2,15)
				term.setTextColor(colors.gray)
				write("   Custom OS   ")
				term.setTextColor(colors.black)
				term.setCursorPos(2,17)
				write("  Main Screen  ")
				local handle = fs.open("/.OSRunner/osConfig","r")
				defaultOS = handle.readLine()
				handle.close()
				local _,p1,xPos,yPos = os.pullEvent("mouse_click")
				if p1 == 1 then
					if (xPos >=3 and xPos <=12 and yPos == 5) then
						if defaultOS == OSList[currentOS] then
							term.setCursorPos(3,5)
							term.setBackgroundColor(colors.red)
							term.write("Default OS")
							local handle = fs.open("/.OSRunner/osConfig","w")
							handle.write(os.version())
							handle.close()
						elseif defaultOS ~= OSList[currentOS] then
							term.setCursorPos(3,5)
							term.setBackgroundColor(colors.lime)
							term.write("Default OS")
							local handle = fs.open("/.OSRunner/osConfig","w")
							handle.writeLine(OSList[currentOS])
							handle.close()
						end
					elseif (xPos >= 2 and xPos <=8 and yPos == 12) and OSList[currentOS-1] ~= nil then
						currentOS = (currentOS-1)
					elseif (xPos >= 43 and xPos <= 50 and yPos ==12) and #OSList >= currentOS+1 then
						currentOS = (currentOS+1)
					elseif (xPos >=2 and xPos <=16 and yPos ==17) then
						return StartLoader()
					end
				end	
			end
		elseif x >= 22 and x <= 30 and y==16 then
			local readConf=fs.open(".OSRunner/OSList/"..OSList[currentOS],"r")
			local dir=readConf.readLine()
			local OSName=readConf.readLine()
			local setupFile=readConf.readLine()
			local setupURL=readConf.readLine()
			readConf.close()
			if not fs.exists(".OSRunner/Kernels/"..OSList[currentOS]) then
				Sand(dir,OSName,setupFile,setupURL)
			else
				Sand(dir,OSName)
			end
			break
		elseif x >= 40 and x <= 44 and y==15 and currentOS > 1 then
			currentOS=1
		elseif x >= 40 and x <= 43 and y==17 and currentOS < #OSList then
			currentOS=#OSList
		end
	end 
end

local function RunDef()
	local ShouldSet = false
	for i,v in pairs(ShouldExist) do
		if not nfs.exists(v) then
			ShouldSet = true
		end 
	end 
	if ShouldSet == true then
		Setup()
	end 
	term.setBackgroundColor(colors.lime)
	term.clear()
	local handle = fs.open("/.OSRunner/osConfig","r")
	defaultOS = handle.readLine()
	handle.close()
	Sand(".OSRunner/Kernels/"..defaultOS, defaultOS)
end 

os.startTimer(3)
while true do
	local event, p1, p2 = os.pullEvent()
	if event == "key" and p1 == 63 then
		StartLoader()
		break
	elseif event == "timer" then
		RunDef()
		break
	end 
end