local StartScreen = paintutils.loadImage(".OSRunner/Resources/logo")
local W, H = term.getSize()
local nfs = {}
for i,v in pairs(fs) do
	nfs[i] = v
end 

local ShouldExist = {
	".OSRunner/Keep";
	".OSRunner/Kernels";
}

shell.run(".OSRunner/APIs/osrunner")

term.setBackgroundColor(colors.lime)
term.clear()
paintutils.drawImage(StartScreen, 8, 4)

term.setCursorPos(1, H)
term.setBackgroundColor(colors.lime)
term.setTextColor(colors.gray)
term.write("Press F5 for OSRunner options")

local function CenterPrint(Text, Line)
	term.setCursorPos((W-#Text)/2, Line)
	print(Text)
end 

local function EraseData()
	if nfs.exists(".OSRunner/Kernels") then
		nfs.delete(".OSRunner/Kernels")
	end 
end 

local function Setup()
	EraseData()
	nfs.makeDir(".OSRunner/Kernels")
	nfs.makeDir(".OSRunner/Keep")
	nfs.makeDir(".OSRunner/Kernels/CraftOS")
end 

local function Sand(Dir)
	os.run({},".OSRunner/APIs/osrunner")
	sandbox.load(Dir .. "/home", "CraftOS 1.5")
end 

local function CheckFiles()

end 

local function StartLoader()
	local ShouldSet = false
	for i,v in pairs(ShouldExist) do
		if not nfs.exists(v) then
			ShouldSet = true
		end 
	end 
	if ShouldSet == true then
		Setup()
	end 
	local Main = paintutils.loadImage(".OSRunner/Resources/main")
	term.setBackgroundColor(colors.white)
	term.clear()
	paintutils.drawImage(Main, 1, 1)
	term.setBackgroundColor(colors.red)
	term.setTextColor(colors.white)
	CenterPrint("OSRunner Options", 1)
	term.setBackgroundColor(colors.lightGray)
	term.setTextColor(colors.black)
	term.setCursorPos(4, 12)
	write("Back")
	term.setCursorPos(45, 12)
	write("Next")
	term.setCursorPos(4, 15)
	write("Download OS")
	term.setCursorPos(2, 17)
	write("System settings")
	term.setCursorPos(22, 16)
	write("Launch OS")
	term.setBackgroundColor(colors.white)
	for i,v in pairs(nfs.list(".OSRunner/Kernels")) do
		term.setBackgroundColor(colors.lightGray)
		term.setCursorPos(2, i + 2)
		term.write(string.rep(" ", W - 2))
		CenterPrint(v, i + 2)
	end 
end 

local function RunDef()
	local ShouldSet = false
	for i,v in pairs(ShouldExist) do
		if not nfs.exists(v) then
			ShouldSet = true
		end 
	end 
	if ShouldSet == true then
		Setup()
	end 
	term.setBackgroundColor(colors.lime)
	term.clear()
	Sand(".OSRunner/Kernels/CraftOS")
end 

os.startTimer(3)
while true do
	local event, p1, p2 = os.pullEvent()
	if event == "key" and p1 == 63 then
		StartLoader()
		break
	elseif event == "timer" then
		RunDef()
		break
	end 
end 